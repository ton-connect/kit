name: Android SDK CI

on:
  pull_request:
    branches:
      - main
    paths:
      - 'apps/androidkit/**'
      - '.github/workflows/android.yml'

jobs:
  # Build JavaScript bundles for WebView and QuickJS
  build-js:
    name: Build JS Bundles
    # runs-on: ubuntu-latest
    runs-on: [self-hosted, k8s, linux]
    container:
      image: node:22
      options: --user root
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read .nvmrc
        run: echo "NVMRC=$(cat .nvmrc)" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NVMRC }}'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages including @ton/walletkit
        run: pnpm build

      - name: Build JS bundles for Android
        working-directory: apps/androidkit
        run: pnpm run build:all

      - name: Upload JS bundles
        uses: actions/upload-artifact@v4
        with:
          name: js-bundles
          path: |
            apps/androidkit/dist-android/
            apps/androidkit/dist-android-quickjs/
          retention-days: 1

  # Code formatting check with Spotless
  spotless:
    name: Spotless Check
    # runs-on: ubuntu-latest
    runs-on: [self-hosted, k8s, linux]
    container:
      image: cimg/android:2025.10-node
      options: --user root
    needs: build-js
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      # - name: Setup Android SDK
      #   uses: android-actions/setup-android@v3

      - name: Download JS bundles
        uses: actions/download-artifact@v4
        with:
          name: js-bundles
          path: apps/androidkit/

      - name: Grant execute permission for gradlew
        working-directory: apps/androidkit/TONWalletKit-Android
        run: chmod +x gradlew

      - name: Run Spotless Check
        working-directory: apps/androidkit/TONWalletKit-Android
        run: ./gradlew spotlessCheck

  # Build and test SDK
  test-sdk:
    name: Test & Build SDK
    # runs-on: ubuntu-latest
    runs-on: [self-hosted, k8s, linux]
    container:
      image: cimg/android:2025.10-node
      options: --user root
    needs: build-js
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      # - name: Setup Android SDK
      #   uses: android-actions/setup-android@v3

      - name: Download JS bundles
        uses: actions/download-artifact@v4
        with:
          name: js-bundles
          path: apps/androidkit/

      - name: Grant execute permission for gradlew
        working-directory: apps/androidkit/TONWalletKit-Android
        run: chmod +x gradlew

      - name: Run unit tests
        working-directory: apps/androidkit/TONWalletKit-Android
        run: ./gradlew :bridge:testWebviewReleaseUnitTest

      - name: Build WebView variant
        working-directory: apps/androidkit/TONWalletKit-Android
        run: ./gradlew buildWebview

      - name: Upload WebView AAR
        uses: actions/upload-artifact@v4
        with:
          name: bridge-webview-release
          path: apps/androidkit/TONWalletKit-Android/bridge/build/outputs/aar/bridge-webview-release.aar
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: apps/androidkit/TONWalletKit-Android/bridge/build/test-results/
          retention-days: 7

  # Build Demo App
  build-demo:
    name: Build Demo App
    # runs-on: ubuntu-latest
    runs-on: [self-hosted, k8s, linux]
    container:
      image: cimg/android:2025.10-node
      options: --user root
    needs: build-js
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      # - name: Setup Android SDK
      #   uses: android-actions/setup-android@v3

      - name: Download JS bundles
        uses: actions/download-artifact@v4
        with:
          name: js-bundles
          path: apps/androidkit/

      - name: Grant execute permission for gradlew (SDK)
        working-directory: apps/androidkit/TONWalletKit-Android
        run: chmod +x gradlew

      - name: Build SDK for Demo
        working-directory: apps/androidkit/TONWalletKit-Android
        run: ./gradlew buildWebview

      - name: Copy AAR to Demo app libs
        run: |
          mkdir -p apps/androidkit/AndroidDemo/app/libs
          cp apps/androidkit/TONWalletKit-Android/bridge/build/outputs/aar/bridge-webview-release.aar apps/androidkit/AndroidDemo/app/libs/bridge-release.aar

      - name: Grant execute permission for gradlew (Demo)
        working-directory: apps/androidkit/AndroidDemo
        run: chmod +x gradlew

      - name: Build Demo App
        working-directory: apps/androidkit/AndroidDemo
        run: ./gradlew assembleDebug

      - name: Upload Demo APK
        uses: actions/upload-artifact@v4
        with:
          name: demo-app-debug
          path: apps/androidkit/AndroidDemo/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
